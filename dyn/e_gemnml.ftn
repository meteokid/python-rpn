***s/r e_gemnml
*
#include <model_macros_f.h>
*
      subroutine e_gemnml 
      implicit none
*
*revision
* v3_11 - Tanguay M.        - Introduce Grd_gauss_L 
*
      integer ni, nila
      integer l_ni,l_nj
      parameter (l_ni=1,l_nj=1)
*implicits
#include "e_topo.cdk"
#include "e_schm.cdk"
#include "e_geol.cdk"
#include "e_grids.cdk"
#include "e_tr.cdk"
#include "e_anal.cdk"
*
#include "cst_lis.cdk"
#include "dcst.cdk"
#include "out1.cdk"
#include "grd.cdk"
#include "p_pbl.cdk"
#include "ptopo.cdk"
#include "pilot.cdk"
#include "hblen.cdk"
#include "e_nml.cdk"
*
      integer  fnom, set_dcst8
      external fnom, set_dcst8
*
      character*120 fn,dumc
      integer i,err,unf
*
*--------------------------------------------------------------------
*
      Grd_typ_S = 'GU'
      Grd_ni    = 0
      Grd_nj    = 0 
      Grd_nila  = 0
      Grd_njla  = 0
      Grd_dx    = 0.
      Grd_dy    = 0.
      Grd_dxmax = 360.
      Grd_dymax = 180.
      Grd_iref  = 1
      Grd_jref  = 1
      Grd_latr  = 0.
      Grd_lonr  = 0.
      Grd_roule = .false.
      Grd_xlon1 = 0.
      Grd_xlat1 = 0.
      Grd_xlon2 = 0.
      Grd_xlat2 = 0.
      Grd_gauss_L = .false.
*
      Pil_runstrt_S =' '
      Pil_ctebcs_L  = .false.
      Pil_nesdt     = 0
      Pil_datacvrg  = 0
*
      Hblen_wfct_S  = 'cos2'
      Hblen_momentx = 10
      Hblen_tx      = 10
      Hblen_massx   = 10
      Hblen_trx     = 10
      Hblen_momenty = -1
      Hblen_ty      = -1
      Hblen_massy   = -1
      Hblen_try     = -1
*
      Topo_filmx_L= .true.
      Topo_init_L = .true.
      Topo_dgfmx_L= .false.
      Topo_dgfms_L= .true.
*
      anal_perturb= .false.
      E_schm_stlag   = .true.
      E_schm_adcub   = .true.
      E_schm_offline_L=.false.
      E_geol_glanl_L = .true.
      E_geol_glreg_L = .false.
      E_geol_hsanl_L = .true.
      E_geol_hscon_L = .false.
      E_geol_hsreg_L = .true.
      E_geol_gls  = 30.
      E_geol_gln  = 80.
      E_geol_glw  = 220.
      E_geol_gle  = 320.
      E_geol_hss  = 30.
      E_geol_hsn  = 80.
      E_geol_hsw  = 220.
      E_geol_hse  = 320.
      E_geol_hsea = 3000
      E_geol_poin = 3
      E_geol_modex_L = .false.
      E_geol_z0cst   = -1.
*
      P_pbl_schsl_S  = 'FCREST'
      P_pbl_snoalb_L = .true.
*
      do i=1, MAXTR
         E_tr3d_list_S(i) = ''
         E_trvs_list_S(i) = ''
      enddo
*
      unf = 0
      fn  = 'process/model_settings'
*      
      write(6,*) 'Opening file: ',fn
      if (fnom(unf, fn,'SEQ+FTN+FMT+OLD',0).ne.0) then
         write(6,*) 'FILE ',fn,' NOT AVAILABLE - ABORT'
         goto 998
      endif
*
      rewind(unf)
      read  (unf,nml=ptopo,  END=930, ERR=930)
      rewind(unf)
      read  (unf,nml=grid,   END=910, ERR=910)
      rewind(unf)
      read  (unf,nml=gement, END=920, ERR=920)
      call fclos (unf)
*
      call low2up (P_pbl_schsl_S,dumc)
      P_pbl_schsl_S = dumc
      call low2up (Grd_typ_S,dumc)
      Grd_typ_S = dumc
      LAM = Grd_typ_S(1:1).eq.'L'
*
*     CONSTANT BOUNDARY CONDITIONS APPLIED in offline mode
      if (E_schm_offline_L) Hblen_wfct_S  = 'const'
*
      Hblen_momentx = max(Hblen_momentx, 0)
      Hblen_tx      = max(Hblen_tx     , 0)
      Hblen_massx   = max(Hblen_massx  , 0)
      Hblen_trx     = max(Hblen_trx    , 0)
      if (Hblen_momenty.lt.0) Hblen_momenty = Hblen_momentx
      if (Hblen_ty     .lt.0) Hblen_ty      = Hblen_tx
      if (Hblen_massy  .lt.0) Hblen_massy   = Hblen_massx
      if (Hblen_try    .lt.0) Hblen_try     = Hblen_trx
*
      if ((LAM).and.((Pil_runstrt_S.eq." ").or.(Pil_nesdt.le.0)
     $           .or.(Pil_datacvrg.le.0))) then
         write(6,1000) 
         call e_arret ('GEMNML')
      endif
*
      if (Grd_ni*Grd_nj.eq.0) then
         write(6,*) 'VERIFY Grd_NI & Grd_NJ IN NAMELIST grid'
         call e_arret ('GEMNML')
      endif
      if (Grd_typ_S(1:1).eq.'G') then
         if (Grd_typ_S(2:2).eq.'U') then
            Grd_nila = Grd_ni
            Grd_njla = Grd_nj
         else
            if (Grd_nila*Grd_njla*Grd_dx*Grd_dy.eq.0) then
               write(6,*) 'VERIFY Grd_NILA, Grd_NJLA, Grd_DX & ',
     $                    'Grd_DY IN NAMELIST grid'
               call e_arret ('GEMNML')
            endif
         endif
         Grd_x0=  0.0 
         Grd_xl=360.0
         Grd_y0=-90.0
         Grd_yl= 90.0
      else
         if (Grd_dx*Grd_dy.eq.0) then
            write(6,*) 'VERIFY Grd_DX & Grd_DY IN NAMELIST grid'
            call e_arret ('GEMNML')
         endif
         Grd_nila = Grd_ni
         Grd_njla = Grd_nj
         Grd_x0   = Grd_lonr - (Grd_iref-1) * Grd_dx
         Grd_y0   = Grd_latr - (Grd_jref-1) * Grd_dy
         Grd_xl   = Grd_x0   + (Grd_ni  -1) * Grd_dx
         Grd_yl   = Grd_y0   + (Grd_nj  -1) * Grd_dy
         if (Grd_x0.lt.0.) Grd_x0=Grd_x0+360.
         if (Grd_xl.lt.0.) Grd_xl=Grd_xl+360.
         if ( (Grd_x0.lt.  0.).or.(Grd_y0.lt.-90.).or.
     $        (Grd_xl.gt.360.).or.(Grd_yl.gt. 90.) ) then
            write (6,1001) Grd_x0,Grd_y0,Grd_xl,Grd_yl
            stop
         endif
      endif
*     
      if (nint( 360./Grd_dxmax ) .gt. Grd_ni+1 .or.
     +    nint( 180./Grd_dymax ) .gt. Grd_nj+1 ) then
         write(6,*) ' INCONSISTENT Grd_NI, Grd_NJ, ',
     $              ' Grd_DXMAX & Grd_DYMAX values in namelist grid'
         call e_arret ('GEMNML')
      endif
*
      write (6  ,nml=grid)
      write (6  ,nml=gement_p)
*
      unf = 44
      if (set_dcst8 (Dcst_cpd_8,liste_S,cnbre,unf,6) .ne. 0)
     $     call e_arret ('SET_DCST8')
*
      call e_trinit
*
      ni   = Grd_ni
      nila = Grd_nila
*
      if (lam) then
          niu = ni-1
      else
          ni=ni+1
          if ( ni .eq. nila+1) nila=nila+1
          niu=ni
      endif
*
      nifi = ni
      niv  = ni
      njfi = Grd_nj
      nju  = Grd_nj
      njv  = Grd_nj-1
      npfi = nifi*njfi
      npu  = niu *nju
      npv  = niv *njv
*     
      if (LAM) then
         pni   = nifi
         pniu  = niu
      else
         pni   = nifi-1
         pniu  = pni
      endif
      pnj   = njfi
      pnjv  = njv
*
      goto 999
 910  write(6,801)
      goto 998
 920  write(6,802)
      goto 998
 930  write(6,803)
 998  call e_arret ('GEMNML')
*
 801  format(/,' ERROR in NAMELIST GRID: STOP IN GEMNTR',/)
 802  format(/,' ERROR in NAMELIST GEMENT: STOP IN GEMNTR',/)
 803  format(/,' ERROR in NAMELIST PTOPO:  STOP IN GEMNTR',/)
 1000 format(/,' Pil_runstrt_S, Pil_nesdt and Pil_datacvrg must'/
     $         ' all be defined in LAM configuration',/)
 1001 format(/,' WRONG LAM GRID CONFIGURATION --- ABORT ---'/,
     $         ' Grd_x0,Grd_y0,Grd_xl,Grd_yl:'/4f10.3/)
*
*--------------------------------------------------------------------
*
 999  return
      end
*
