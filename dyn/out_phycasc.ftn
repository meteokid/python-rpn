!-------------------------------------- LICENCE BEGIN ------------------------------------
!Environment Canada - Atmospheric Science and Technology License/Disclaimer, 
!                     version 3; Last Modified: May 7, 2008.
!This is free but copyrighted software; you can use/redistribute/modify it under the terms 
!of the Environment Canada - Atmospheric Science and Technology License/Disclaimer 
!version 3 or (at your option) any later version that should be found at: 
!http://collaboration.cmc.ec.gc.ca/science/rpn.comm/license.html 
!
!This software is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; 
!without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. 
!See the above mentioned License/Disclaimer for more details.
!You should have received a copy of the License/Disclaimer along with this software; 
!if not, you can write to: EC-RPN COMM Group, 2121 TransCanada, suite 500, Dorval (Quebec), 
!CANADA, H9P 1J3; or send e-mail to service.rpn@ec.gc.ca
!-------------------------------------- LICENCE END --------------------------------------
***s/r out_phycasc - to save PERBUS variables in obus for cascade output
*
#include "model_macros_f.h"
*
      subroutine  out_phycasc ( F_cpu, F_step, F_obusval )
      implicit none
*
      integer F_cpu, F_step
      real F_obusval(*)
*
*author 
*     Vivian Lee  - rpn - Oct  2006
*
*revision
* v3_30 - Lee V             - Removed Mem_phyncore
*
#include "glb_ld.cdk"
#include "lun.cdk"
#include "cstv.cdk"
#include "itf_phy_buses.cdk"
*
      integer jdo, i, j, k, n, indx, err,idx
      integer busaddr,offbo,offbb,mult,cnt,shp,bigk
      real dt
*
      real busper, busper2(max(1,p_bper_siz))
      pointer (pabusper,busper(*))
*
*     ---------------------------------------------------------------
*
      if ((Lun_out.gt.0).and.(F_cpu.eq.1)) write(Lun_out,1000)
*
      dt  = Cstv_dt_8
      jdo = 0
*
 100  continue
*
      jdo  = jdo + 1
      if ( jdo .le. p_nj ) then
         pabusper = loc (Phy_busper3D((jdo-1)*p_bper_siz+1))
      else
         goto 650
      endif

      j = jdo + p_offj
*
*     Perform physic slices output

      bigk = 1

      do idx=1,p_bper_top
         offbo=(bigk-1)*l_ni*l_nj
         offbb=perpar(idx,1)
         if (perpar(idx,5).gt.p_ni) then
            shp=l_nk+2
         else
            shp=1
         endif
         do mult=1,perpar(idx,6)
         do k=1,shp
         do i=1,p_ni
            F_obusval(offbo+(k*mult-1)*l_ni*l_nj +
     $                   (j-1)*l_ni + i+ p_offi)=
     $      busper(offbb+(k*mult-1)*p_ni + i - 1)
         enddo
         enddo
         enddo
         bigk = bigk + shp*perpar(idx,6)
      enddo
*
      goto 100
*
 650  continue     
*
 1000 format(/'PERFORM A PHYSICS CASC: CMC/RPN PHYSICS (S/R OUT_PHYCASC)'
     $       /55('='))
*
*     ---------------------------------------------------------------
*
      return
      end
