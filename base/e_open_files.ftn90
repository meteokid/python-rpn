!---------------------------------- LICENCE BEGIN -------------------------------
! GEM - Library of kernel routines for the GEM numerical atmospheric model
! Copyright (C) 1990-2010 - Division de Recherche en Prevision Numerique
!                       Environnement Canada
! This library is free software; you can redistribute it and/or modify it 
! under the terms of the GNU Lesser General Public License as published by
! the Free Software Foundation, version 2.1 of the License. This library is
! distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
! without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
! PARTICULAR PURPOSE. See the GNU Lesser General Public License for more details.
! You should have received a copy of the GNU Lesser General Public License
! along with this library; if not, write to the Free Software Foundation, Inc.,
! 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
!---------------------------------- LICENCE END ---------------------------------

!**s/r e_open_files
!
#include "model_macros_f.h"
!
      subroutine e_open_files (current_date)
      implicit none
#include <arch_specific.hf>
!
      integer current_date
!
!author 
!    Michel Desgagne - Summer 2008
!
!revision
! v3_31 - Desgagne M.       - Initial version
! v4_03 - Lee/Desgagne - ISST
!
#include "e_anal.cdk"
#include "e_grids.cdk"
#include "e_topo.cdk"
#include "bmf.cdk"
#include "ptopo.cdk"
#include "e_cdate.cdk"
#include "e_schm.cdk"
#include "pilot1.cdk"
#include "e_grdc.cdk"
#include "grd.cdk"
#include "path.cdk"
#include <clib_interface.cdk>
!
      integer, external :: newdate
      character*16 pdate
      character*1024 rootfn,filen
      integer yy,mm,dd,dum
      integer is,js,jn,iw,ie,jw,njw,niw,nis,njs,err
!
! ---------------------------------------------------------------------
!
      call datf2p (pdate,current_date)

      rootfn=trim(Path_output_S)//'/GEMDM_input/'
      
      err = clib_mkdir (trim(rootfn))

      if (Grd_yinyang_L) then
         rootfn=trim(rootfn)//'/'//trim(Grd_yinyang_S)
         err = clib_mkdir (trim(rootfn))
      endif

      if (Pil_bmf_L) then

         err = newdate ( current_date, bmf_time1, bmf_time2, -3 )
         call prsdate  ( yy,mm,dd,Bmf_hh,Bmf_mm,Bmf_ss,dum,pdate)

         call bmf_splitstart (Ptopo_nblocx,Ptopo_nblocy,trim(rootfn), &
                              'BM',Bmf_time1,Bmf_hh,Bmf_mm,Bmf_ss)
         call e_bmfsplitxy2  (topo ,nifi,njfi,'ME  ',1,1,pni ,0,0,0)
         call bmf_splitwrall ('RNA ',LV,1,1,Bmf_time1,Bmf_time2,  &
                                          0,0,bmf_dtyp,0,RNA)
         call bmf_splitwrall ('ZA  ',LV,1,1,Bmf_time1,Bmf_time2, &
                                          0,0,81,0,ZA_8)
         call bmf_splitwrall ('ZB  ',LV,1,1,Bmf_time1,Bmf_time2, &
                                          0,0,81,0,ZB_8)
         call bmf_splitwrall ('ZAT ',LV_T,1,1,Bmf_time1,Bmf_time2, &
                                          0,0,81,0,ZAT_8)
         call bmf_splitwrall ('ZBT ',LV_T,1,1,Bmf_time1,Bmf_time2, &
                                          0,0,81,0,ZBT_8)
      else

!        Write out the 3df_filemap.txt
!
         filen=trim(rootfn)//'/3df_'//trim(pdate)//'_filemap.txt'
         open (9,file=filen,access='SEQUENTIAL',form='FORMATTED')
         write (9,'(2i8,4e15.7,2i10,l4)')1,1, &
                     xg_8(e_grdc_gid),xg_8(e_grdc_gif), &
                     yg_8(e_grdc_gjd),yg_8(e_grdc_gjf), &
                     e_grdc_gif-e_grdc_gid+1,           &
                     e_grdc_gjf-e_grdc_gjd+1,.false.
         close (9)
         call e_sfile_3df (pdate,'DYNAMICS', &
              e_grdc_gid,e_grdc_gif,e_grdc_gjd,e_grdc_gjf,rootfn)

      endif
!
! ---------------------------------------------------------------------
!
      return
      end
