! ------------------------------------------------------------------------------------------------------------------------------
! EC-RPN COMM Group License/Disclaimer, version 2, Last Modified: Jan 08th, 2008 , Environment Canada
! 
! This is free software, you can use/redistribute/modify it under the terms of the EC-RPN COMM Group License/Disclaimer version 2 
! or (at your option) any later version that should be found at http://collaboration.cmc.ec.gc.ca/science/rpn.comm/license.html 
! 
! This software is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the EC-RPN COMM Group License/Disclaimer for more details.
! 
! You should have received a copy of the EC-RPN COMM Group License/Disclaimer along with this software; if not, write to the
! EC-RPN COMM Group, 2121 TransCanada, suite 500, Dorval (Quebec), CANADA, H9P 1J3 ; or send e-mail to service.rpn@ec.gc.ca
! ------------------------------------------------------------------------------------------------------------------------------
***s/r v4d_rwtraj_dyn - For DYNAMICS: Read (Write) from (on) TRAJ WA file at each time step 
*
#include "model_macros_f.h"
*
      subroutine v4d_rwtraj_dyn (numtr,u,v,w)
*
*-------------------------------------------------------------------------
*  CAUTION: Parameters list is extended ONLY when numtr=5
*-------------------------------------------------------------------------
*
      implicit none
*
      integer numtr
*
c     real, optional ::  u(*),v(*),w(*) KO NAOS
      real           ::  u(*),v(*),w(*)
*
*author
*     M.Tanguay
*
*revision
* v2_10 - Tanguay M.        - initial MPI version
* v2_21 - Tanguay M.        - ADJ of HO option
*                           - ADJ of vertical sponge layer
* v2_31 - Tanguay M.        - adapt for vertical hybrid coordinate 
*                           - change parameters of v4d_rwfld 
*                           - introduce v4d_rwfldx 
*                           - adapt for tracers in tr3d  
* v3_03 - Tanguay M.        - Adjoint NoHyd configuration 
* v3_11 - Tanguay M.        - Remove HU in numtr.eq.1 
*                           - ADJ of digital filter 
* v3_20 - Tanguay M.        - Option of storing instead of redoing TRAJ 
* v3_30 - Tanguay M.        - Validation for LAM Nonhyd
* v4_04 - Tanguay M.        - Staggered version TL/AD 
* v4_10 - Tanguay M.        - VMM replacement with GMM for (TL/AD)
*
*object
*     see id section 
*
*arguments
* Name         I/O     Description
*-------------------------------------------------------------------------
* numtr        I       Indicates which portion of TRAJECTORY to Read-Write 
*-------------------------------------------------------------------------
*
*implicits
#include "gmm.hf"
#include "var_gmm.cdk"
#include "glb_ld.cdk"
#include "lun.cdk"
#include "lctl.cdk"
#include "vt1.cdk"
#include "vt1_m.cdk"
#include "vtx.cdk"
#include "vtx_m.cdk"
#include "vth.cdk"
#include "vth_m.cdk"
#include "rhsc.cdk"
#include "rhsc_m.cdk"
#include "vt0.cdk"
#include "vt0_m.cdk"
#include "v4dg.cdk"
#include "schm.cdk"
#include "orh.cdk"
#include "cori.cdk"
#include "tr3d.cdk"
#include "nl.cdk"
#include "nl_m.cdk"
#include "nest.cdk"
#include "nest_m.cdk"
#include "step.cdk"
*
      real, pointer, dimension(:,:,:) :: tr0,tr1,trn,tr0_m,tr1_m,trn_m
*
      integer istep,i,j,k,n,iadd
*
      logical plpr_L
*     ______________________________________________________
*
      if (numtr     .gt.MAX_TR_NUMTR) call gem_stop('RWTRAJ_DYN numtr KO ',-1) 
      if (Step_total.gt.MAX_TR_STEP ) call gem_stop('RWTRAJ_DYN step  KO ',-1) 
      if (Schm_itcn .gt.MAX_TR_ITCN ) call gem_stop('RWTRAJ_DYN itcn  KO ',-1) 
      if (Schm_itnlh.gt.MAX_TR_ITNLH) call gem_stop('RWTRAJ_DYN itnlh KO ',-1) 
*
      if (numtr.gt.10) call gem_stop('ABORT v4d_rwtraj_dyn numtr not done',-1) 
*
*     Flag to trace storing and retrieving of trajectory
*     --------------------------------------------------
      plpr_L = .false.
      plpr_L = plpr_L.and.Lun_out.gt.0 
*
      istep = Lctl_step 
*
*     ------------------
*     TRAJ initial state
*     ------------------
      if (numtr.eq.1) then
*
*        ----------------
*        Read TRAJ Fields 
*        ----------------
         if (V4dg_rwtr.eq.0) then
*
*        Recover starting address 
*        ------------------------
         if (V4dg_ad_L) iadd = V4dg_addtab_ad(numtr,istep,1,1) 
         if (V4dg_tl_L) iadd = V4dg_addtab_tl(numtr,istep,1,1) 
*
         gmmstat = gmm_get(gmmk_ut1_m_s,ut1_m,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(ut1_m)'
         gmmstat = gmm_get(gmmk_vt1_m_s,vt1_m,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(vt1_m)'
         gmmstat = gmm_get(gmmk_tt1_m_s,tt1_m,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(tt1_m)'
         gmmstat = gmm_get(gmmk_st1_m_s,st1_m,meta2d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(st1_m)'
*
*        TANGENT LINEAR MODEL
*        --------------------
         if (V4dg_tl_L) then
*
            call v4d_rwfld (ut1_m,LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'UT1_M   ',V4dg_ad_L,0,-1)
*
            call v4d_rwfld (vt1_m,LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'VT1_M   ',V4dg_ad_L,0,-1)
*
            call v4d_rwfld (st1_m,LDIST_DIM,1,
     %                      iadd,plpr_L,'ST1_M   ',V4dg_ad_L,0,-1)
*
            call v4d_rwfld (tt1_m,LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'TT1_M   ',V4dg_ad_L,0,-1)
*
         endif
*
*        ADJOINT MODEL
*        -------------
         if (V4dg_ad_L) then
*
            call v4d_rwfld (tt1_m,LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'TT1_M   ',V4dg_ad_L,
     %                      l_ni*l_nj         ,-1)
*
            call v4d_rwfld (st1_m,LDIST_DIM,1,
     %                      iadd,plpr_L,'ST1_M   ',V4dg_ad_L,
     %                      l_ni*l_nj*l_nk    ,-1)
*
            call v4d_rwfld (vt1_m,LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'VT1_M   ',V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+1),-1)
*
            call v4d_rwfld (ut1_m,LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'UT1_M   ',V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+2),-1)
*
         endif
*
*        -----------------
*        Write TRAJ Fields 
*        -----------------
         elseif(V4dg_rwtr.eq.1) then
*
         gmmstat = gmm_get(gmmk_ut1_s,ut1,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(ut1)'
         gmmstat = gmm_get(gmmk_vt1_s,vt1,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(vt1)'
         gmmstat = gmm_get(gmmk_tt1_s,tt1,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(tt1)'
         gmmstat = gmm_get(gmmk_st1_s,st1,meta2d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(st1)'
*
*        Store starting TLM address
*        --------------------------
         V4dg_addtab_tl(numtr,istep,1,1) = V4dg_addtr 
         iadd                            = V4dg_addtr 
*
            call v4d_rwfld (ut1,LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'UT1     ',V4dg_ad_L,0,1)
*
            call v4d_rwfld (vt1,LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'VT1     ',V4dg_ad_L,0,1)
*
            call v4d_rwfld (st1,LDIST_DIM,1,
     %                      iadd,plpr_L,'ST1     ',V4dg_ad_L,0,1)
*
            call v4d_rwfld (tt1,LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'TT1     ',V4dg_ad_L,0,1)
*
*        Store starting ADJOINT address 
*        ------------------------------
         V4dg_addtab_ad(numtr,istep,1,1) = iadd - l_ni*l_nj*(l_nk+1)
         V4dg_addtr                      = iadd
*
         endif
*
      endif

*     --------------------------------------------------------------
*     TRAJ predictive variables 
*     NOTE:Fields are recovered at a fixed icn and keep their values 
*     --------------------------------------------------------------
      if (numtr.eq.2) then
*
         if (V4dg_di_L.and..NOT.(Orh_crank_L.and.Orh_icn.eq.1))         return
         if (V4dg_tl_L.and..NOT.(Orh_crank_L.and.Orh_icn.eq.1))         return
         if (V4dg_ad_L.and..NOT.(Orh_crank_L.and.Orh_icn.eq.Schm_itcn)) return
*
*        ----------------
*        Read TRAJ Fields 
*        ----------------
         if (V4dg_rwtr.eq.0) then
*
*        Recover starting address
*        ------------------------
         if (V4dg_ad_L) iadd = V4dg_addtab_ad(numtr,istep,1,1) 
         if (V4dg_tl_L) iadd = V4dg_addtab_tl(numtr,istep,1,1) 
*
         gmmstat = gmm_get(gmmk_ut1_m_s,ut1_m,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(ut1_m)'
         gmmstat = gmm_get(gmmk_vt1_m_s,vt1_m,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(vt1_m)'
         gmmstat = gmm_get(gmmk_tt1_m_s,tt1_m,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(tt1_m)'
         gmmstat = gmm_get(gmmk_st1_m_s,st1_m,meta2d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(st1_m)'
         gmmstat = gmm_get(gmmk_zdt1_m_s,zdt1_m,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(zdt1_m)'
         gmmstat = gmm_get(gmmk_bspqtx_m_s,bspqtx_m,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(bspqtx_m)'
         gmmstat = gmm_get(gmmk_wt1_m_s,wt1_m,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(wt1_m)'
*
         if (.not. Schm_hydro_L) then
             gmmstat = gmm_get(gmmk_qt1_m_s,qt1_m,meta3d)
             if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(qt1_m)'
             gmmstat = gmm_get(gmmk_mutx_m_s,mutx_m,meta3d)
             if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(mutx_m)'
         endif
*
*        TANGENT LINEAR MODEL
*        --------------------
         if (V4dg_tl_L) then
*
            call v4d_rwfld (ut1_m,   LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'UT1_M   ',V4dg_ad_L,0,-1)
*
            call v4d_rwfld (vt1_m,   LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'VT1_M   ',V4dg_ad_L,0,-1)
*
            call v4d_rwfld (tt1_m,   LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'TT1_M   ',V4dg_ad_L,0,-1)
*
            call v4d_rwfld (st1_m,   LDIST_DIM,1,
     %                      iadd,plpr_L,'ST1_M   ',V4dg_ad_L,0,-1)
*
            call v4d_rwfld (zdt1_m,  LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'ZDT1_M  ',V4dg_ad_L,0,-1)
*
            call v4d_rwfld (bspqtx_m,LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'BSPQTX_M',V4dg_ad_L,0,-1)
*
            call v4d_rwfld (wt1_m,   LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'WT1_M   ',V4dg_ad_L,0,-1)
*
            do n=1,Tr3d_ntr
*
               gmmstat = gmm_get('TRM/'//trim(Tr3d_name_S(n))//':P',tr1_m,meta3d)
*
               call v4d_rwfld (tr1_m,LDIST_DIM,l_nk+2,
     %                         iadd,plpr_L,'TRT1_M  ', V4dg_ad_L,0,-1)
*
            enddo
*
            if (.not. Schm_hydro_L) then
            call v4d_rwfld (qt1_m,   LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'QT1_M   ',V4dg_ad_L,0,-1)
            call v4d_rwfld (mutx_m,  LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'MUTX_M  ',V4dg_ad_L,0,-1)
            endif
*
         endif
*
*        ADJOINT MODEL 
*        -------------
         if (V4dg_ad_L) then
*
            if (.not. Schm_hydro_L) then
            call v4d_rwfld (mutx_m,  LDIST_DIM,l_nk+1,
     %                     iadd,plpr_L,'MUTX_M  ',V4dg_ad_L, 
     %                     l_ni*l_nj*(l_nk+2),-1)
            call v4d_rwfld (qt1_m,   LDIST_DIM,l_nk+2,
     %                     iadd,plpr_L,'QT1_M   ',V4dg_ad_L, 
     %                     l_ni*l_nj*(l_nk+2),-1)
            endif
*
*           CAUTION: To be verified
            do n=1,Tr3d_ntr
*
               gmmstat = gmm_get('TRM/'//trim(Tr3d_name_S(n))//':P',tr1_m,meta3d)
*
               if (n.ne.1) then
                  call v4d_rwfld (tr1_m,LDIST_DIM,l_nk+2,
     %                            iadd,plpr_L,'TRT1_M  ', V4dg_ad_L,
     %                            l_ni*l_nj*(l_nk+2),-1)
               else
                  call v4d_rwfld (tr1_m,LDIST_DIM,l_nk+2,
     %                            iadd,plpr_L,'TRT1_M  ', V4dg_ad_L,
     %                            l_ni*l_nj*(l_nk+1),-1)
               endif
*
            enddo
*
            call v4d_rwfld (wt1_m,   LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'WT1_M   ',V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+2),-1)
*
            call v4d_rwfld (bspqtx_m,LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'BSPQTX_M',V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+1),-1)
*
            call v4d_rwfld (zdt1_m,  LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'ZDT1_M  ',V4dg_ad_L,
     %                      l_ni*l_nj,-1)
*
            call v4d_rwfld (st1_m,   LDIST_DIM,1,
     %                      iadd,plpr_L,'ST1_M   ',V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+2),-1)
*
            call v4d_rwfld (tt1_m,   LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'TT1_M   ',V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+1),-1)
*
            call v4d_rwfld (vt1_m,   LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'VT1_M   ',V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+1),-1)
*
            if (.not. Schm_hydro_L) then
            call v4d_rwfld (ut1_m,   LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'UT1_M   ',V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+1),-1)
            else
            call v4d_rwfld (ut1_m,   LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'UT1_M   ',V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+2),-1)
            endif
*
         endif
*
*        -----------------
*        Write TRAJ Fields 
*        -----------------
         elseif(V4dg_rwtr.eq.1) then
*
         gmmstat = gmm_get(gmmk_ut1_s,ut1,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(ut1)'
         gmmstat = gmm_get(gmmk_vt1_s,vt1,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(vt1)'
         gmmstat = gmm_get(gmmk_tt1_s,tt1,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(tt1)'
         gmmstat = gmm_get(gmmk_st1_s,st1,meta2d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(st1)'
         gmmstat = gmm_get(gmmk_zdt1_s,zdt1,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(zdt1)'
         gmmstat = gmm_get(gmmk_bspqtx_s,bspqtx,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(bspqtx)'
         gmmstat = gmm_get(gmmk_wt1_s,wt1,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(wt1)'
*
         if (.not. Schm_hydro_L) then
             gmmstat = gmm_get(gmmk_qt1_s,qt1,meta3d)
             if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(qt1)'
             gmmstat = gmm_get(gmmk_mutx_s,mutx,meta3d)
             if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(mutx)'
         endif
*
*        Store starting TLM address
*        --------------------------
         V4dg_addtab_tl(numtr,istep,1,1) = V4dg_addtr 
         iadd                            = V4dg_addtr
*
            call v4d_rwfld (ut1,    LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'UT1     ',V4dg_ad_L,0,1)
*
            call v4d_rwfld (vt1,    LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'VT1     ',V4dg_ad_L,0,1)
*
            call v4d_rwfld (tt1,    LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'TT1     ',V4dg_ad_L,0,1)
*
            call v4d_rwfld (st1,    LDIST_DIM,1,
     %                      iadd,plpr_L,'ST1     ',V4dg_ad_L,0,1)
*
            call v4d_rwfld (zdt1,   LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'ZDT1    ',V4dg_ad_L,0,1)
*
            call v4d_rwfld (bspqtx, LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'BSPQTX  ',V4dg_ad_L,0,1)
*
            call v4d_rwfld (wt1,    LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'WT1     ',V4dg_ad_L,0,1)
*
            do n=1,Tr3d_ntr
*
               gmmstat = gmm_get('TR/'//trim(Tr3d_name_S(n))//':P',tr1,meta3d)
*
               call v4d_rwfld (tr1,LDIST_DIM,l_nk+2,
     %                         iadd,plpr_L,'TRT1    ', V4dg_ad_L,0,1)
*
            enddo
*
            if (.not. Schm_hydro_L) then
            call v4d_rwfld (qt1,    LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'QT1     ',V4dg_ad_L,0,1)
            call v4d_rwfld (mutx,   LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'MUTX    ',V4dg_ad_L,0,1)
            endif
*
*        Store starting ADJOINT address
*        ------------------------------
         if (.not. Schm_hydro_L) then
         V4dg_addtab_ad(numtr,istep,1,1) = iadd - l_ni*l_nj*(l_nk+1)
         else
         V4dg_addtab_ad(numtr,istep,1,1) = iadd - l_ni*l_nj*(l_nk+2)
         endif
         V4dg_addtr                      = iadd
*
         endif
*
      endif
*
*     --------------------------------------------------------------
*     TRAJ Positions at time TH before ADV_MAIN modified by ADV_MAIN 
*     NOTE:Fields are changed at each icn 
*     --------------------------------------------------------------
      if (numtr.eq.3) then
*
*        ----------------
*        Read TRAJ Fields 
*        ----------------
         if (V4dg_rwtr.eq.0) then
*
*        Recover starting address
*        ------------------------
         if (V4dg_ad_L) iadd = V4dg_addtab_ad(numtr,istep,Orh_icn,1)  
         if (V4dg_tl_L) iadd = V4dg_addtab_tl(numtr,istep,Orh_icn,1) 
*
         gmmstat = gmm_get(gmmk_xth_m_s,xth_m,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(xth_m)'
         gmmstat = gmm_get(gmmk_yth_m_s,yth_m,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(yth_m)'
         gmmstat = gmm_get(gmmk_zth_m_s,zth_m,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(zth_m)'

         gmmstat = gmm_get(gmmk_xcth_m_s,xcth_m,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(xcth_m)'
         gmmstat = gmm_get(gmmk_ycth_m_s,ycth_m,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(ycth_m)'
         gmmstat = gmm_get(gmmk_zcth_m_s,zcth_m,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(zcth_m)'
*
*        TANGENT LINEAR MODEL
*        --------------------
         if (V4dg_tl_L) then
*
            call v4d_rwfldx(xcth_m,l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'XCTH_M  ',V4dg_ad_L,0,-1)
*
            call v4d_rwfldx(ycth_m,l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'YCTH_M  ',V4dg_ad_L,0,-1)
*
            call v4d_rwfldx(zcth_m,l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'ZCTH_M  ',V4dg_ad_L,0,-1)
*
            call v4d_rwfldx(xth_m, l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'XTH_M   ',V4dg_ad_L,0,-1)
*
            call v4d_rwfldx(yth_m, l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'YTH_M   ',V4dg_ad_L,0,-1)
*
            call v4d_rwfldx(zth_m, l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'ZTH_M   ',V4dg_ad_L,0,-1)
*
         endif
*
*        ADJOINT MODEL 
*        -------------
         if (V4dg_ad_L) then
*
            call v4d_rwfldx(zth_m, l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'ZTH_M   ',V4dg_ad_L,
     %                      l_ni*l_nj*l_nk,-1)
*
            call v4d_rwfldx(yth_m, l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'YTH_M   ',V4dg_ad_L,
     %                      l_ni*l_nj*l_nk,-1)
*
            call v4d_rwfldx(xth_m, l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'XTH_M   ',V4dg_ad_L,
     %                      l_ni*l_nj*l_nk,-1)
*
            call v4d_rwfldx(zcth_m,l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'ZCTH_M  ',V4dg_ad_L,
     %                      l_ni*l_nj*l_nk,-1)
*
            call v4d_rwfldx(ycth_m,l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'YCTH_M  ',V4dg_ad_L,
     %                      l_ni*l_nj*l_nk,-1)
*
            call v4d_rwfldx(xcth_m,l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'XCTH_M  ',V4dg_ad_L,
     %                      l_ni*l_nj*l_nk,-1)
*
         endif
*
*        -----------------
*        Write TRAJ Fields 
*        -----------------
         elseif(V4dg_rwtr.eq.1) then
*
         gmmstat = gmm_get(gmmk_xth_s,xth,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(xth)'
         gmmstat = gmm_get(gmmk_yth_s,yth,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(yth)'
         gmmstat = gmm_get(gmmk_zth_s,zth,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(zth)'
*
         gmmstat = gmm_get(gmmk_xcth_s,xcth,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(xcth)'
         gmmstat = gmm_get(gmmk_ycth_s,ycth,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(ycth)'
         gmmstat = gmm_get(gmmk_zcth_s,zcth,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(zcth)'
*
*        Store starting TLM address
*        --------------------------
         V4dg_addtab_tl(numtr,istep,Orh_icn,1) = V4dg_addtr 
         iadd                                  = V4dg_addtr 
*
            call v4d_rwfldx(xcth,l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'XCTH    ',V4dg_ad_L,0,1)
*
            call v4d_rwfldx(ycth,l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'YCTH    ',V4dg_ad_L,0,1)
*
            call v4d_rwfldx(zcth,l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'ZCTH    ',V4dg_ad_L,0,1)
*
            call v4d_rwfldx(xth, l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'XTH     ',V4dg_ad_L,0,1)
*
            call v4d_rwfldx(yth, l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'YTH     ',V4dg_ad_L,0,1)
*
            call v4d_rwfldx(zth, l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'ZTH     ',V4dg_ad_L,0,1)
*
*        Store starting ADJOINT address
*        ------------------------------
         V4dg_addtab_ad(numtr,istep,Orh_icn,1) = iadd - l_ni*l_nj*l_nk
         V4dg_addtr                            = iadd
*
         endif
*
      endif
*
*     --------------------------------------------------------------
*     TRAJ Winds at time TH before ADV_MAIN NOT modified by ADV_MAIN 
*     NOTE:Fields are changed at each icn
*     --------------------------------------------------------------
      if (numtr.eq.4) then    
*
*        ----------------
*        Read TRAJ Fields 
*        ----------------
         if (V4dg_rwtr.eq.0) then
*
*        Recover starting address
*        ------------------------
         if (V4dg_ad_L) iadd = V4dg_addtab_ad(numtr,istep,Orh_icn,1) 
         if (V4dg_tl_L) iadd = V4dg_addtab_tl(numtr,istep,Orh_icn,1) 
*
         gmmstat = gmm_get(gmmk_uth_m_s,uth_m,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(uth_m)'
         gmmstat = gmm_get(gmmk_vth_m_s,vth_m,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(vth_m)'
         gmmstat = gmm_get(gmmk_zdth_m_s,zdth_m,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(zdth_m)'
*
*        TANGENT LINEAR MODEL
*        --------------------
         if (V4dg_tl_L) then
*
            call v4d_rwfld (uth_m,  LDIST_DIM,l_nk,
     %                      iadd,plpr_L,'UTH_M   ',V4dg_ad_L,0,-1)
*
            call v4d_rwfld (vth_m,  LDIST_DIM,l_nk,
     %                      iadd,plpr_L,'VTH_M   ',V4dg_ad_L,0,-1)
*
            call v4d_rwfld (zdth_m, LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'ZDTH_M  ',V4dg_ad_L,0,-1)
*
         endif
*
*        ADJOINT MODEL 
*        -------------
         if (V4dg_ad_L) then
*
            call v4d_rwfld (zdth_m, LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'ZDTH_M  ',V4dg_ad_L,
     %                      l_ni*l_nj*l_nk,-1)
*
            call v4d_rwfld (vth_m,  LDIST_DIM,l_nk,
     %                      iadd,plpr_L,'VTH_M   ',V4dg_ad_L,
     %                      l_ni*l_nj*l_nk,-1)
*
            call v4d_rwfld (uth_m,  LDIST_DIM,l_nk,
     %                      iadd,plpr_L,'UTH_M   ',V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+1),-1)
*
         endif
*
*        -----------------
*        Write TRAJ Fields 
*        -----------------
         elseif(V4dg_rwtr.eq.1) then
*
         gmmstat = gmm_get(gmmk_uth_s,uth,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(uth)'
         gmmstat = gmm_get(gmmk_vth_s,vth,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(vth)'
         gmmstat = gmm_get(gmmk_zdth_s,zdth,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(zdth)'
*
*        Store starting TLM address
*        --------------------------
         V4dg_addtab_tl(numtr,istep,Orh_icn,1) = V4dg_addtr 
         iadd                                  = V4dg_addtr
*
         call v4d_rwfld (uth,  LDIST_DIM,l_nk,
     %                   iadd,plpr_L,'UTH     ',V4dg_ad_L,0,1)

         call v4d_rwfld (vth,  LDIST_DIM,l_nk,
     %                   iadd,plpr_L,'VTH     ',V4dg_ad_L,0,1)
*
         call v4d_rwfld (zdth, LDIST_DIM,l_nk+1,
     %                   iadd,plpr_L,'ZDTH    ',V4dg_ad_L,0,1)
*
*        Store starting ADJOINT address
*        ------------------------------
         V4dg_addtab_ad(numtr,istep,Orh_icn,1) = iadd - l_ni*l_nj*(l_nk+1)
         V4dg_addtr                            = iadd
*
         endif
*
      endif 
*
*     -----------------------
*     TRAJ upstream positions 
*     -----------------------
      if (numtr.eq.5) then
*
*        ----------------
*        Read TRAJ Fields 
*        ----------------
         if (V4dg_rwtr.eq.0) then
*
*        Recover starting address 
*        ------------------------
         if (V4dg_ad_L) iadd = V4dg_addtab_ad(numtr,istep,Orh_icn,1) 
         if (V4dg_tl_L) iadd = V4dg_addtab_tl(numtr,istep,Orh_icn,1) 
*
*        TANGENT LINEAR MODEL
*        --------------------
         if (V4dg_tl_L) then
*
            call v4d_rwfldx(u,l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'F_U_M   ',V4dg_ad_L,0,-1)
*
            call v4d_rwfldx(v,l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'F_V_M   ',V4dg_ad_L,0,-1)
*
            call v4d_rwfldx(w,l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'F_W_M   ',V4dg_ad_L,0,-1)
*
         endif
*
*        ADJOINT MODEL
*        -------------
         if (V4dg_ad_L) then
*
            call v4d_rwfldx(w, l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'F_W_M   ',V4dg_ad_L,
     %                      l_ni*l_nj*l_nk,-1)
* 
            call v4d_rwfldx(v, l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'F_V_M   ',V4dg_ad_L,
     %                      l_ni*l_nj*l_nk,-1)
*
            call v4d_rwfldx(u, l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'F_U_M   ',V4dg_ad_L,
     %                      l_ni*l_nj*l_nk,-1)
*
         endif
*
*        -----------------
*        Write TRAJ Fields 
*        -----------------
         elseif(V4dg_rwtr.eq.1) then
*
*        Store starting TLM address
*        --------------------------
         V4dg_addtab_tl(numtr,istep,Orh_icn,1) = V4dg_addtr 
         iadd                                  = V4dg_addtr 
*
            call v4d_rwfldx(u,l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'F_U     ',V4dg_ad_L,0,1)
*
            call v4d_rwfldx(v,l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'F_V     ',V4dg_ad_L,0,1)
*
            call v4d_rwfldx(w,l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'F_W     ',V4dg_ad_L,0,1)
*
*
*        Store starting ADJOINT address 
*        ------------------------------
         V4dg_addtab_ad(numtr,istep,Orh_icn,1) = iadd - l_ni*l_nj*l_nk
         V4dg_addtr                            = iadd
*
         endif
*
      endif
*
*     ----------------------------
*     TRAJ RHS interpolated fields 
*     ----------------------------
      if (numtr.eq.6) then
*
*        ----------------
*        Read TRAJ Fields
*        ----------------
         if (V4dg_rwtr.eq.0) then
*
*        Recover starting address
*        ------------------------
         if (V4dg_ad_L) iadd = V4dg_addtab_ad(numtr,istep,Orh_icn,1) 
         if (V4dg_tl_L) iadd = V4dg_addtab_tl(numtr,istep,Orh_icn,1) 
*
         gmmstat = gmm_get(gmmk_ruw2_m_s,ruw2_m,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(ruw2_m)'
         gmmstat = gmm_get(gmmk_rvw2_m_s,rvw2_m,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(rvw2_m)'
         gmmstat = gmm_get(gmmk_rhsc_m_s,rhsc_m,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(rhsc_m)'
         gmmstat = gmm_get(gmmk_rhst_m_s,rhst_m,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(rhst_m)'
*
         gmmstat = gmm_get(gmmk_xct1_m_s,xct1_m,tmp_meta1d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(xct1_m)'
         gmmstat = gmm_get(gmmk_yct1_m_s,yct1_m,tmp_meta1d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(yct1_m)'
         gmmstat = gmm_get(gmmk_zct1_m_s,zct1_m,tmp_meta1d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(zct1_m)'
*
         if (.not. Schm_hydro_L) then
             gmmstat = gmm_get(gmmk_rhsw_m_s,rhsw_m,meta3d)
             if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(rhsw_m)'
             gmmstat = gmm_get(gmmk_rhsf_m_s,rhsf_m,meta3d)
             if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(rhsf_m)'
         endif
*
*        TANGENT LINEAR MODEL
*        --------------------
         if (V4dg_tl_L) then
*
            call v4d_rwfld (ruw2_m,LDIST_DIM,l_nk,
     %                      iadd,plpr_L,'RUW2_M  ',V4dg_ad_L,0,-1)
*
            call v4d_rwfld (rvw2_m,LDIST_DIM,l_nk,
     %                      iadd,plpr_L,'RVW2_M  ',V4dg_ad_L,0,-1)
*
            call v4d_rwfld (rhsc_m,LDIST_DIM,l_nk,
     %                      iadd,plpr_L,'RHSC_M  ',V4dg_ad_L,0,-1)
*
            call v4d_rwfld (rhst_m,LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'RHST_M  ',V4dg_ad_L,0,-1)
*
            call v4d_rwfldx(xct1_m,l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'XCT1_M  ',V4dg_ad_L,0,-1)
*
            call v4d_rwfldx(yct1_m,l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'YCT1_M  ',V4dg_ad_L,0,-1)
*
            call v4d_rwfldx(zct1_m,l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'ZCT1_M  ',V4dg_ad_L,0,-1)
*
            if (.not. Schm_hydro_L) then
            call v4d_rwfld (rhsw_m,LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'RHSW_M  ',V4dg_ad_L,0,-1)
*
            call v4d_rwfld (rhsf_m,LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'RHSF_M  ',V4dg_ad_L,0,-1)
            endif
*
         endif
*
*        ADJOINT MODEL 
*        -------------
         if (V4dg_ad_L) then
*
            if (.not. Schm_hydro_L) then
            call v4d_rwfld (rhsf_m,LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'RHSW_M  ',V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+1),-1)
            call v4d_rwfld (rhsw_m,LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'RHSF_M  ',V4dg_ad_L,
     %                      l_ni*l_nj*l_nk,-1)
            endif
*
            call v4d_rwfldx(zct1_m,l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'ZCT1_M  ',V4dg_ad_L,
     %                      l_ni*l_nj*l_nk,-1)
*
            call v4d_rwfldx(yct1_m,l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'YCT1_M  ',V4dg_ad_L,
     %                      l_ni*l_nj*l_nk,-1)
*
            call v4d_rwfldx(xct1_m,l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'XCT1_M  ',V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+1),-1)
*
            call v4d_rwfld (rhst_m,LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'RHST_M  ',V4dg_ad_L,
     %                      l_ni*l_nj*l_nk,-1)
*
            call v4d_rwfld (rhsc_m,LDIST_DIM,l_nk,
     %                      iadd,plpr_L,'RHSC_M  ',V4dg_ad_L,
     %                      l_ni*l_nj*l_nk,-1)
*
            call v4d_rwfld (rvw2_m,LDIST_DIM,l_nk,
     %                      iadd,plpr_L,'RVW2_M  ',V4dg_ad_L,
     %                      l_ni*l_nj*l_nk,-1)
*
            if (.not. Schm_hydro_L) then
            call v4d_rwfld (ruw2_m,LDIST_DIM,l_nk,
     %                      iadd,plpr_L,'RUW2_M  ',V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+1),-1)
            else
            call v4d_rwfld (ruw2_m,LDIST_DIM,l_nk,
     %                      iadd,plpr_L,'RUW2_M  ',V4dg_ad_L,
     %                      l_ni*l_nj*l_nk,-1)
            endif
*
         endif
*
*        -----------------
*        Write TRAJ Fields 
*        -----------------
         elseif(V4dg_rwtr.eq.1) then
*
         gmmstat = gmm_get(gmmk_ruw2_s,ruw2,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(ruw2)'
         gmmstat = gmm_get(gmmk_rvw2_s,rvw2,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(rvw2)'
         gmmstat = gmm_get(gmmk_rhsc_s,rhsc,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(rhsc)'
         gmmstat = gmm_get(gmmk_rhst_s,rhst,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(rhst)'
*
         gmmstat = gmm_get(gmmk_xct1_s,xct1,tmp_meta1d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(xct1)'
         gmmstat = gmm_get(gmmk_yct1_s,yct1,tmp_meta1d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(yct1)'
         gmmstat = gmm_get(gmmk_zct1_s,zct1,tmp_meta1d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(zct1)'
*
         if (.not. Schm_hydro_L) then
             gmmstat = gmm_get(gmmk_rhsw_s,rhsw,meta3d)
             if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(rhsw)'
             gmmstat = gmm_get(gmmk_rhsf_s,rhsf,meta3d)
             if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(rhsf)'
         endif
*
*        Store starting TLM address
*        --------------------------
         V4dg_addtab_tl(numtr,istep,Orh_icn,1) = V4dg_addtr 
         iadd                                  = V4dg_addtr
*
            call v4d_rwfld (ruw2,LDIST_DIM,l_nk,
     %                      iadd,plpr_L,'RUW2    ',V4dg_ad_L,0,1)
*
            call v4d_rwfld (rvw2,LDIST_DIM,l_nk,
     %                      iadd,plpr_L,'RVW2    ',V4dg_ad_L,0,1)
*
            call v4d_rwfld (rhsc,LDIST_DIM,l_nk,
     %                      iadd,plpr_L,'RHSC    ',V4dg_ad_L,0,1)
*
            call v4d_rwfld (rhst,LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'RHST    ',V4dg_ad_L,0,1)
*
            call v4d_rwfldx(xct1,l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'XCT1    ',V4dg_ad_L,0,1)
*
            call v4d_rwfldx(yct1,l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'YCT1    ',V4dg_ad_L,0,1)
*
            call v4d_rwfldx(zct1,l_ni,l_nj,l_nk,
     %                      iadd,plpr_L,'ZCT1    ',V4dg_ad_L,0,1)
*
            if (.not. Schm_hydro_L) then
            call v4d_rwfld (rhsw,LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'RHSW    ',V4dg_ad_L,0,1)
            call v4d_rwfld (rhsf,LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'RHSF    ',V4dg_ad_L,0,1)
            endif
*
*        Store starting ADJOINT address
*        ------------------------------
         if (.not. Schm_hydro_L) then
         V4dg_addtab_ad(numtr,istep,Orh_icn,1) = iadd - l_ni*l_nj*(l_nk+1)
         else
         V4dg_addtab_ad(numtr,istep,Orh_icn,1) = iadd - l_ni*l_nj* l_nk
         endif
         V4dg_addtr                            = iadd
*
         endif
*
      endif 
*
*     ----------------------------------------
*     TRAJ modified by BAC at previous Orh_icn 
*     ----------------------------------------
      if (numtr.eq.7) then
*
*        ----------------
*        Read TRAJ Fields
*        ----------------
         if (V4dg_rwtr.eq.0) then
*
*        Recover starting address
*        ------------------------
         if (V4dg_ad_L) iadd = V4dg_addtab_ad(numtr,istep,Orh_icn,1) 
         if (V4dg_tl_L) iadd = V4dg_addtab_tl(numtr,istep,Orh_icn,1) 
*
         gmmstat = gmm_get(gmmk_tt0_m_s,tt0_m,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(tt0_m)'
         gmmstat = gmm_get(gmmk_zdt0_m_s,zdt0_m,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(zdt0_m)'
         gmmstat = gmm_get(gmmk_st0_m_s,st0_m,meta2d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(st0_m)'
         gmmstat = gmm_get(gmmk_fiptx_m_s,fiptx_m,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(fiptx_m)'
*
         if (Cori_cornl_L) then
             gmmstat = gmm_get(gmmk_ut0_m_s,ut0_m,meta3d)
             if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(ut0_m)'
             gmmstat = gmm_get(gmmk_vt0_m_s,vt0_m,meta3d)
             if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(vt0_m)'
         endif
         if (.not. Schm_hydro_L) then
             gmmstat = gmm_get(gmmk_qt0_m_s,qt0_m,meta3d)
             if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(qt0_m)'
         endif
*
*        TANGENT LINEAR MODEL
*        --------------------
         if (V4dg_tl_L) then
*
            if (Cori_cornl_L) then
            call v4d_rwfld (ut0_m,  LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'UT0_M   ',V4dg_ad_L,0,-1)
*
            call v4d_rwfld (vt0_m,  LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'VT0_M   ',V4dg_ad_L,0,-1)
            endif
*
            call v4d_rwfld (tt0_m,  LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'TT0_M   ',V4dg_ad_L,0,-1)
*
            call v4d_rwfld (zdt0_m, LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'ZDT0_M  ',V4dg_ad_L,0,-1)
*
            call v4d_rwfld (st0_m,  LDIST_DIM,1,
     %                      iadd,plpr_L,'ST0_M   ',V4dg_ad_L,0,-1)
*
            call v4d_rwfld (fiptx_m,LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'FIPTX_M ',V4dg_ad_L,0,-1)
*
            if (.not. Schm_hydro_L) then
            call v4d_rwfld (qt0_m,  LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'QT0_M   ',V4dg_ad_L,0,-1)
            endif
*
         endif
*
*        ADJOINT MODEL 
*        -------------
         if (V4dg_ad_L) then
*
            if (.not. Schm_hydro_L) then
            call v4d_rwfld (qt0_m,  LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'QT0_M   ',V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+2),-1)
            endif
*
            call v4d_rwfld (fiptx_m,LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'FIPTX_M ',V4dg_ad_L,
     %                      l_ni*l_nj,-1)
*
            call v4d_rwfld (st0_m,  LDIST_DIM,1,
     %                      iadd,plpr_L,'ST0_M   ',V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+1),-1)
*
            call v4d_rwfld (zdt0_m, LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'ZDT0_M  ',V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+2),-1)
*
            if (Cori_cornl_L) then
            call v4d_rwfld (tt0_m,  LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'TT0_M   ',V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+1),-1)
            else
            call v4d_rwfld (tt0_m,  LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'TT0_M   ',V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+2),-1)
            endif
*
            if (Cori_cornl_L) then
            call v4d_rwfld (vt0_m,  LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'VT0_M   ',V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+1),-1)
            call v4d_rwfld (ut0_m,  LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'UT0_M   ',V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+2),-1)
            endif
*
         endif
*
*        -----------------
*        Write TRAJ Fields 
*        -----------------
         elseif(V4dg_rwtr.eq.1) then
*
         gmmstat = gmm_get(gmmk_tt0_s,tt0,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(tt0)'
         gmmstat = gmm_get(gmmk_zdt0_s,zdt0,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(zdt0)'
         gmmstat = gmm_get(gmmk_st0_s,st0,meta2d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(st0)'
         gmmstat = gmm_get(gmmk_fiptx_s,fiptx,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(fiptx)'
*
         if (Cori_cornl_L) then
             gmmstat = gmm_get(gmmk_ut0_s,ut0,meta3d)
             if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(ut0)'
             gmmstat = gmm_get(gmmk_vt0_s,vt0,meta3d)
             if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(vt0)'
         endif
         if (.not. Schm_hydro_L) then
             gmmstat = gmm_get(gmmk_qt0_s,qt0,meta3d)
             if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(qt0)'
         endif
*
*        Store starting TLM address
*        --------------------------
         V4dg_addtab_tl(numtr,istep,Orh_icn,1) = V4dg_addtr 
         iadd                                  = V4dg_addtr
*
            if (Cori_cornl_L) then
            call v4d_rwfld (ut0,  LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'UT0     ',V4dg_ad_L,0,1)
*
            call v4d_rwfld (vt0,  LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'VT0     ',V4dg_ad_L,0,1)
            endif
*
            call v4d_rwfld (tt0,  LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'TT0     ',V4dg_ad_L,0,1)
*
            call v4d_rwfld (zdt0, LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'ZDT0    ',V4dg_ad_L,0,1)
*
            call v4d_rwfld (st0,  LDIST_DIM,1,
     %                      iadd,plpr_L,'ST0     ',V4dg_ad_L,0,1)
*
            call v4d_rwfld (fiptx,LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'FIPTX   ',V4dg_ad_L,0,1)
*
         if (.not. Schm_hydro_L) then
            call v4d_rwfld (qt0,  LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'QT0     ',V4dg_ad_L,0,1)
         endif
*
*        Store starting ADJOINT address
*        ------------------------------
         V4dg_addtab_ad(numtr,istep,Orh_icn,1) = iadd - l_ni*l_nj*(l_nk+2)
         V4dg_addtr                            = iadd
*
         endif
*
      endif 
*
*     ------------------------------
*     TRAJ requested to build BAC_TR 
*     ------------------------------
      if (numtr.eq.8) then
*
*        ----------------
*        Read TRAJ Fields 
*        ----------------
         if (V4dg_rwtr.eq.0) then
*
*        Recover starting address 
*        ------------------------
         if (V4dg_ad_L) iadd = V4dg_addtab_ad(numtr,istep,Orh_icn,V4dg_iln)
         if (V4dg_tl_L) iadd = V4dg_addtab_tl(numtr,istep,Orh_icn,V4dg_iln)
*
*        NOTE: st0 is requested also (in LAM: see bacp_2)  
*
         gmmstat = gmm_get(gmmk_fiptx_m_s,fiptx_m,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(fiptx_m)'
         gmmstat = gmm_get(gmmk_rhst_m_s,rhst_m,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(rhst_m)'
         gmmstat = gmm_get(gmmk_st0_m_s,st0_m,meta2d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(st0_m)'
*
         if (.not. Schm_hydro_L) then
             gmmstat = gmm_get(gmmk_qt0_m_s,qt0_m,meta3d)
             if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(qt0_m)'
         endif
*
*        TANGENT LINEAR MODEL
*        --------------------
         if (V4dg_tl_L) then
*
            call v4d_rwfld (fiptx_m,LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'FIPTX_M  ',V4dg_ad_L,0,-1)
*
            call v4d_rwfld (rhst_m,LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'RHST_M   ',V4dg_ad_L,0,-1)
*
            call v4d_rwfld (nl_m_t,LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'NL_M_T   ',V4dg_ad_L,0,-1)
*
            call v4d_rwfld (st0_m,LDIST_DIM,1,
     %                      iadd,plpr_L,'ST0_M    ',V4dg_ad_L,0,-1)
*
            if (.not. Schm_hydro_L) then
            call v4d_rwfld (qt0_m,LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'QT0_M    ',V4dg_ad_L,0,-1)
            endif
*
         endif
*
*        ADJOINT MODEL
*        -------------
         if (V4dg_ad_L) then
*
            if (.not. Schm_hydro_L) then
            call v4d_rwfld (qt0_m,  LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'QT0_M   ',V4dg_ad_L,
     %                      l_ni*l_nj,-1)
            endif
*
            call v4d_rwfld (st0_m,  LDIST_DIM,1,
     %                      iadd,plpr_L,'ST0_M   ',V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+1),-1)
*
            call v4d_rwfld (nl_m_t, LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'NL_M_T  ',V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+1),-1)
*
            call v4d_rwfld (rhst_m, LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'RHST_M  ',V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+2),-1)
*
            if (.not. Schm_hydro_L) then
            call v4d_rwfld (fiptx_m,LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'FIPTX_M  ',V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+2),-1)
            else
            call v4d_rwfld (fiptx_m,LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'FIPTX_M  ',V4dg_ad_L,
     %                      l_ni*l_nj,-1)
            endif
*
         endif
*
*        -----------------
*        Write TRAJ Fields 
*        -----------------
         elseif(V4dg_rwtr.eq.1) then
*
         gmmstat = gmm_get(gmmk_fiptx_s,fiptx,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(fiptx)'
         gmmstat = gmm_get(gmmk_rhst_s,rhst,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(rhst)'
         gmmstat = gmm_get(gmmk_st0_s,st0,meta2d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(st0)'
*
         if (.not. Schm_hydro_L) then
             gmmstat = gmm_get(gmmk_qt0_m_s,qt0_m,meta3d)
             if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(qt0_m)'
         endif
*
*        Store starting TLM address
*        --------------------------
         V4dg_addtab_tl(numtr,istep,Orh_icn,V4dg_iln) = V4dg_addtr 
         iadd                                         = V4dg_addtr 
*
            call v4d_rwfld (fiptx, LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'FIPTX   ',V4dg_ad_L,0,1)
*
            call v4d_rwfld (rhst,  LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'RHST    ',V4dg_ad_L,0,1)
*
            call v4d_rwfld (nl_t,  LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'NL_T    ',V4dg_ad_L,0,1)
*
            call v4d_rwfld (st0,   LDIST_DIM,1,
     %                      iadd,plpr_L,'ST0     ',V4dg_ad_L,0,1)
*
            if (.not. Schm_hydro_L) then
            call v4d_rwfld (qt0,   LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'QT0     ',V4dg_ad_L,0,1)
            endif
*
*        Store starting ADJOINT address 
*        ------------------------------
         if (.not. Schm_hydro_L) then
         V4dg_addtab_ad(numtr,istep,Orh_icn,V4dg_iln) = iadd - l_ni*l_nj*(l_nk+2) 
         else
         V4dg_addtab_ad(numtr,istep,Orh_icn,V4dg_iln) = iadd - l_ni*l_nj 
         endif
         V4dg_addtr                                   = iadd
*
         endif
*
      endif
*
*     ----------------------------
*     TRAJ requested during BAC_AD
*     ----------------------------
      if (numtr.eq.9) then
*
*        ----------------
*        Read TRAJ Fields 
*        ----------------
         if (V4dg_rwtr.eq.0) then
*
*        Recover starting address 
*        ------------------------
         if (V4dg_ad_L) iadd = V4dg_addtab_ad(numtr,istep,Orh_icn,V4dg_iln)
         if (V4dg_tl_L) iadd = V4dg_addtab_tl(numtr,istep,Orh_icn,V4dg_iln)
*
         gmmstat = gmm_get(gmmk_fiptx_m_s,fiptx_m,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(fiptx_m)'
         gmmstat = gmm_get(gmmk_st0_m_s,st0_m,meta2d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(st0_m)'
*
*        TANGENT LINEAR MODEL
*        --------------------
         if (V4dg_tl_L) then
*
            call v4d_rwfld (fiptx_m,LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'FIPTX_M  ',V4dg_ad_L,0,-1)
*
            call v4d_rwfld (st0_m,  LDIST_DIM,1,
     %                      iadd,plpr_L,'ST0_M    ',V4dg_ad_L,0,-1)
*
         endif
*
*        ADJOINT MODEL
*        -------------
         if (V4dg_ad_L) then
*
            call v4d_rwfld (st0_m,  LDIST_DIM,1,
     %                      iadd,plpr_L,'ST0_M    ',V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+2),-1)
*
            call v4d_rwfld (fiptx_m,LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'FIPTX_M  ',V4dg_ad_L,
     %                      l_ni*l_nj,-1)
*
         endif
*
*        -----------------
*        Write TRAJ Fields 
*        -----------------
         elseif(V4dg_rwtr.eq.1) then
*
         gmmstat = gmm_get(gmmk_fiptx_s,fiptx,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(fiptx)'
         gmmstat = gmm_get(gmmk_st0_s,st0,meta2d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(st0)'
*
*        Store starting TLM address
*        --------------------------
         V4dg_addtab_tl(numtr,istep,Orh_icn,V4dg_iln) = V4dg_addtr 
         iadd                                         = V4dg_addtr 
*
            call v4d_rwfld (fiptx, LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'FIPTX   ',V4dg_ad_L,0,1)
*
            call v4d_rwfld (st0,   LDIST_DIM,1,
     %                      iadd,plpr_L,'ST0     ',V4dg_ad_L,0,1)
*
*        Store starting ADJOINT address 
*        ------------------------------
         V4dg_addtab_ad(numtr,istep,Orh_icn,V4dg_iln) = iadd - l_ni*l_nj 
         V4dg_addtr                                   = iadd
*
         endif
*
      endif
*
*     ---------------------------------------------------------------
*     TRAJ NEST 
*     ---------------------------------------------------------------
      if (numtr.eq.10.and.G_lam) then
*
*        ----------------
*        Read TRAJ Fields 
*        ----------------
         if (V4dg_rwtr.eq.0) then
*
*        Recover starting address 
*        ------------------------
         if (V4dg_di_L) iadd = V4dg_addtab_tl(numtr,istep,1,1)
         if (V4dg_tl_L) iadd = V4dg_addtab_tl(numtr,istep,1,1)
         if (V4dg_ad_L) iadd = V4dg_addtab_ad(numtr,istep,1,1)
*
         if(V4dg_tl_L.or.V4dg_ad_L) then
*
         gmmstat = gmm_get(gmmk_nest_u_m_s ,nest_u_m ,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(nest_u_m)'
         gmmstat = gmm_get(gmmk_nest_v_m_s ,nest_v_m ,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(nest_v_m)'
         gmmstat = gmm_get(gmmk_nest_w_m_s ,nest_w_m ,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(nest_w_m)'
         gmmstat = gmm_get(gmmk_nest_t_m_s ,nest_t_m ,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(nest_t_m)'
         gmmstat = gmm_get(gmmk_nest_zd_m_s,nest_zd_m,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(nest_zd_m)'
         gmmstat = gmm_get(gmmk_nest_s_m_s ,nest_s_m ,meta2d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(nest_s_m)'
*
         if (.not. Schm_hydro_L) then
             gmmstat = gmm_get(gmmk_nest_q_m_s,nest_q_m,meta3d)
             if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(nest_q_m)'
         endif
*
         elseif(V4dg_di_L) then
*
         gmmstat = gmm_get(gmmk_nest_u_s ,nest_u ,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(nest_u)'
         gmmstat = gmm_get(gmmk_nest_v_s ,nest_v ,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(nest_v)'
         gmmstat = gmm_get(gmmk_nest_w_s ,nest_w ,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(nest_w)'
         gmmstat = gmm_get(gmmk_nest_t_s ,nest_t ,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(nest_t)'
         gmmstat = gmm_get(gmmk_nest_zd_s,nest_zd,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(nest_zd)'
         gmmstat = gmm_get(gmmk_nest_s_s ,nest_s ,meta2d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(nest_s)'
*
         if (.not. Schm_hydro_L) then
             gmmstat = gmm_get(gmmk_nest_q_s,nest_q,meta3d)
             if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(nest_q)'
         endif
*
         endif
*
*        FORWARD MODEL
*        -------------
         if (V4dg_di_L) then
*
            call v4d_rwfld (nest_u,  LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'N_U     ',   V4dg_ad_L,0,-1)
*
            call v4d_rwfld (nest_v,  LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'N_V     ',   V4dg_ad_L,0,-1)
*
            call v4d_rwfld (nest_w,  LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'N_W     ',   V4dg_ad_L,0,-1)
*
            call v4d_rwfld (nest_t,  LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'N_T     ',   V4dg_ad_L,0,-1)
*
            call v4d_rwfld (nest_zd, LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'N_ZD    ',   V4dg_ad_L,0,-1)
*
            call v4d_rwfld (nest_s,  LDIST_DIM,1,
     %                      iadd,plpr_L,'N_S     ',   V4dg_ad_L,0,-1)
*
            if (.not.Schm_hydro_L) then
*
            call v4d_rwfld (nest_q,  LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'N_Q     ',   V4dg_ad_L,0,-1)
*
            endif
*
            do n=1,Tr3d_ntr
*
               gmmstat = gmm_get('NEST/'//trim(Tr3d_name_S(n))//':C',trn,meta3d)
*
               call v4d_rwfld (trn,LDIST_DIM,l_nk+2,
     %                         iadd,plpr_L,'N_TR    ', V4dg_ad_L,0,-1)
*
            enddo
*
         endif
*
*        TANGENT LINEAR MODEL
*        --------------------
         if (V4dg_tl_L) then
*
            call v4d_rwfld (nest_u_m,  LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'N_U_M   ',   V4dg_ad_L,0,-1)
*
            call v4d_rwfld (nest_v_m,  LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'N_V_M   ',   V4dg_ad_L,0,-1)
*
            call v4d_rwfld (nest_w_m,  LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'N_W_M   ',   V4dg_ad_L,0,-1)
*
            call v4d_rwfld (nest_t_m,  LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'N_T_M   ',   V4dg_ad_L,0,-1)
*
            call v4d_rwfld (nest_zd_m, LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'N_ZD_M  ',   V4dg_ad_L,0,-1)
*
            call v4d_rwfld (nest_s_m,  LDIST_DIM,1,
     %                      iadd,plpr_L,'N_S_M   ',   V4dg_ad_L,0,-1)
*
            if (.not.Schm_hydro_L) then
*
            call v4d_rwfld (nest_q_m,  LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'N_Q_M   ',   V4dg_ad_L,0,-1)
*
            endif
*
            do n=1,Tr3d_ntr
*
               gmmstat = gmm_get('TRM/'//trim(Tr3d_name_S(n))//':N',trn_m,meta3d)
*
               call v4d_rwfld (trn_m,LDIST_DIM,l_nk+2,
     %                         iadd,plpr_L,'N_TR_M  ', V4dg_ad_L,0,-1)
*
            enddo
*
         endif
*
*        ADJOINT MODEL
*        -------------
         if (V4dg_ad_L) then
*
*           CAUTION: To be verified
*
            do n=Tr3d_ntr,1,-1
*
               gmmstat = gmm_get('TRM/'//trim(Tr3d_name_S(n))//':N',trn_m,meta3d)
*
               if (n.ne.1) then
                  call v4d_rwfld (trn_m,LDIST_DIM,l_nk+2,
     %                            iadd,plpr_L,'N_TR_M  ', V4dg_ad_L,
     %                            l_ni*l_nj*(l_nk+2),-1)
               else
                  if (.not.Schm_hydro_L) then
                  call v4d_rwfld (trn_m,LDIST_DIM,l_nk+2,
     %                            iadd,plpr_L,'N_TR_M  ', V4dg_ad_L,
     %                            l_ni*l_nj*(l_nk+2),-1)
                  else
                  call v4d_rwfld (trn_m,LDIST_DIM,l_nk+2,
     %                            iadd,plpr_L,'N_TR_M  ', V4dg_ad_L,
     %                            l_ni*l_nj,-1)
                  endif
               endif
*
            end do
*
            if (.not.Schm_hydro_L) then
*
            call v4d_rwfld (nest_q_m,  LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'N_Q_M   ',  V4dg_ad_L,
     %                      l_ni*l_nj,-1)
*
            endif
*
            call v4d_rwfld (nest_s_m,  LDIST_DIM,1,
     %                      iadd,plpr_L,'N_S_M   ',  V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+1),-1)
*
            call v4d_rwfld (nest_zd_m, LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'N_ZD_M  ',  V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+2),-1)
*
            call v4d_rwfld (nest_t_m,  LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'N_T_M   ',  V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+1),-1)
*
            call v4d_rwfld (nest_w_m,  LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'N_W_M   ',  V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+1),-1)
*
            call v4d_rwfld (nest_v_m,  LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'N_V_M   ',  V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+1),-1)
*
            if (.not.Schm_hydro_L) then
            call v4d_rwfld (nest_u_m,  LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'N_U_M   ',  V4dg_ad_L,
     %                      l_ni*l_nj*(l_nk+2),-1)
            else
            call v4d_rwfld (nest_u_m,  LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'N_U_M   ',  V4dg_ad_L,
     %                      l_ni*l_nj,-1)
            endif
*
         endif
*
*        -----------------
*        Write TRAJ Fields 
*        -----------------
         elseif(V4dg_rwtr.eq.1) then
*
         gmmstat = gmm_get(gmmk_nest_u_s ,nest_u ,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(nest_u)'
         gmmstat = gmm_get(gmmk_nest_v_s ,nest_v ,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(nest_v)'
         gmmstat = gmm_get(gmmk_nest_w_s ,nest_w ,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(nest_w)'
         gmmstat = gmm_get(gmmk_nest_t_s ,nest_t ,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(nest_t)'
         gmmstat = gmm_get(gmmk_nest_zd_s,nest_zd,meta3d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(nest_zd)'
         gmmstat = gmm_get(gmmk_nest_s_s ,nest_s ,meta2d)
         if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(nest_s)'
*
         if (.not. Schm_hydro_L) then
             gmmstat = gmm_get(gmmk_nest_q_s,nest_q,meta3d)
             if (GMM_IS_ERROR(gmmstat)) print *,'v4d_rwtraj_dyn ERROR at gmm_get(nest_q)'
         endif
*
*        Store starting TLM address
*        --------------------------
         V4dg_addtab_tl(numtr,istep,1,1) = V4dg_addtr
         iadd                            = V4dg_addtr
*
            call v4d_rwfld (nest_u,  LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'N_U     ',   V4dg_ad_L,0,1)
*
            call v4d_rwfld (nest_v,  LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'N_V     ',   V4dg_ad_L,0,1)
*
            call v4d_rwfld (nest_w,  LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'N_W     ',   V4dg_ad_L,0,1)
*
            call v4d_rwfld (nest_t,  LDIST_DIM,l_nk+2,
     %                      iadd,plpr_L,'N_T     ',   V4dg_ad_L,0,1)
*
            call v4d_rwfld (nest_zd, LDIST_DIM,l_nk+1,
     %                      iadd,plpr_L,'N_ZD    ',   V4dg_ad_L,0,1)
*
            call v4d_rwfld (nest_s,  LDIST_DIM,1,
     %                      iadd,plpr_L,'N_S     ',   V4dg_ad_L,0,1)
*
            if (.not.Schm_hydro_L) then
*
            call v4d_rwfld (nest_q,  LDIST_DIM,l_nk,
     %                      iadd,plpr_L,'N_Q     ',   V4dg_ad_L,0,1)
*
            endif
*
            do n=1,Tr3d_ntr
*
               gmmstat = gmm_get('NEST/'//trim(Tr3d_name_S(n))//':C',trn,meta3d)
*
               call v4d_rwfld (trn,LDIST_DIM,l_nk+2,
     %                         iadd,plpr_L,'N_TR    ', V4dg_ad_L,0,1)
*
            enddo
*
*        Store starting ADJOINT address 
*        ------------------------------
         V4dg_addtab_ad(numtr,istep,1,1) = iadd - l_ni*l_nj*(l_nk+1)
         V4dg_addtr                      = iadd
*
         endif
*
      endif
*
      return
      end
